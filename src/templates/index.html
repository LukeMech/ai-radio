<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Stream</title>
</head>
<body>
    <button id="playPauseButton">Play</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js" integrity="sha512-tE1z+95+lMCGwy+9PnKgUSIeHhvioC9lMlI7rLWU0Ps3XTdjRygLcy4mLuL0JAoK4TLdQEyP0yOl/9dMOqpH/Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const playPauseButton = document.getElementById('playPauseButton');
        var audio = {}
        audio.paused = true

        function genereteDeviceId() {
            return 'xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        const devId = genereteDeviceId()

        async function fetchAudio() {
            const requestOptions = {
                headers: {
                    'devid': devId
                }
            };  
            const url = '/listen/';
            // fetch() returns a promise that resolves once headers have been received
            return fetch(url, requestOptions)
                .then(res => {
                if (!res.ok)
                    throw new Error('Network response was not ok');

                // Calling getReader() gives us exclusive access to
                // the stream's content      
                var reader = res.body.getReader();

                // read() returns a promise that resolves when a value has been received      
                return reader
                    .read()
                    .then((result) => {
                        return result;
                    });
                })
        }

        // Connect to WebSocket
        var socket = io({
            extraHeaders: {
                'devid': devId // Generuj i dodaj nagłówek devid przy połączeniu WebSocket
            }
        });
        socket.on('connect', function() {
            console.log('Authorized via websocket');
        });
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            try {audio.pause()} catch(e) {}
            playPauseButton.textContent = 'Play';
        });

        playPauseButton.addEventListener('click', function() {
            if (!audio.paused) {       
                audio.pause();
                audio.src=''
                playPauseButton.textContent = 'Play';
            } 
            else {
                playPauseButton.textContent = 'Loading...';   
                audio = new Audio();
                // Fetch the audio stream with headers
                fetchAudio()
                    .then((response) => {
                        // response.value for fetch streams is a Uint8Array
                        var blob = new Blob([response.value], { type: 'audio/mpeg' });
                        var url = window.URL.createObjectURL(blob)

                        audio = new Audio();
                        audio.src = url;
                        audio.play();
                        // Update the button text
                        playPauseButton.textContent = 'Pause';   
                    })
                    .catch((error) => {
                        console.error(error)
                    });
            }
        });
    </script>    
</body>
</html>